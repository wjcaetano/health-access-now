# üß™ GUIA DE TESTES - AGENDAJA

## üìã √çndice
- [6.1 Testes de Seguran√ßa](#61-testes-de-seguran√ßa)
- [6.2 Testes de Fluxos Completos](#62-testes-de-fluxos-completos)
- [6.3 Checklist de Performance](#63-checklist-de-performance)

---

## 6.1 Testes de Seguran√ßa

### üîí Teste 1: Row Level Security (RLS)

#### Objetivo
Validar que usu√°rios s√≥ podem acessar seus pr√≥prios dados e n√£o conseguem acessar dados de outros usu√°rios.

#### Cen√°rios de Teste

##### A) Cliente A tentando acessar agendamentos do Cliente B

**Setup:**
1. Criar dois clientes (Cliente A e Cliente B) no sistema
2. Cada cliente tem agendamentos associados
3. Login como Cliente A

**Teste:**
```sql
-- Como Cliente A (user_id = UUID_A)
-- Esta query deve retornar APENAS agendamentos do Cliente A
SELECT * FROM agendamentos WHERE cliente_id = 'UUID_B';
-- ‚ùå Deve retornar: 0 registros (RLS bloqueando)
```

**Via API (Frontend):**
```typescript
// Como Cliente A logado
const { data } = await supabase
  .from('agendamentos')
  .select('*')
  .eq('cliente_id', 'UUID_DO_CLIENTE_B'); // Tentando acessar dados de outro cliente

// ‚ùå Esperado: data = [] (RLS deve bloquear)
```

**Resultado Esperado:**
- ‚úÖ RLS deve bloquear o acesso
- ‚úÖ Nenhum dado do Cliente B deve ser retornado
- ‚úÖ Sem erros expostos ao usu√°rio

---

##### B) Prestador A tentando ver guias do Prestador B

**Setup:**
1. Criar dois prestadores (Prestador A e Prestador B)
2. Cada prestador tem guias associadas
3. Login como Prestador A

**Teste:**
```sql
-- Como Prestador A
SELECT * FROM guias WHERE prestador_id = 'UUID_PRESTADOR_B';
-- ‚ùå Deve retornar: 0 registros
```

**Via API:**
```typescript
// Como Prestador A logado
const { data } = await supabase
  .from('guias')
  .select('*')
  .eq('prestador_id', 'UUID_DO_PRESTADOR_B');

// ‚ùå Esperado: data = []
```

**Resultado Esperado:**
- ‚úÖ RLS deve bloquear
- ‚úÖ Dados de outro prestador n√£o devem vazar

---

### üîê Teste 2: Escala√ß√£o de Privil√©gios

#### Objetivo
Validar que usu√°rios n√£o podem escalar privil√©gios tentando acessar funcionalidades de roles superiores.

#### Cen√°rios de Teste

##### A) Atendente tentando acessar configura√ß√µes (admin-only)

**Setup:**
1. Login como usu√°rio com role 'atendente'
2. Tentar acessar rota `/hub/configuracoes`

**Teste Manual:**
1. Login como atendente
2. Navegar diretamente para: `/hub/configuracoes`
3. Ou via c√≥digo:
```typescript
// Como atendente logado
const { data } = await supabase
  .from('organizacoes')
  .update({ configuracoes: { teste: true } })
  .eq('id', 'UUID_ORGANIZACAO');

// ‚ùå Deve falhar - RLS deve bloquear
```

**Resultado Esperado:**
- ‚úÖ Rota deve redirecionar ou mostrar "Acesso negado"
- ‚úÖ Guard deve bloquear acesso: `AdminGuard`
- ‚úÖ RLS deve impedir update na tabela

---

##### B) Colaborador tentando ver financeiro (gerente-only)

**Setup:**
1. Login como colaborador
2. Tentar acessar `/hub/financeiro`

**Teste:**
```typescript
// Como colaborador
const { data } = await supabase
  .from('contas_pagar')
  .select('*');

// ‚ùå Esperado: erro ou data = []
```

**Resultado Esperado:**
- ‚úÖ Acesso negado pela RLS policy
- ‚úÖ Guard de rota deve bloquear

---

### üõ°Ô∏è Teste 3: SQL Injection

#### Objetivo
Validar que inputs de usu√°rio n√£o podem ser usados para SQL injection.

#### Cen√°rios de Teste

##### A) Busca de Clientes com input malicioso

**Setup:**
```typescript
// Tentar injetar SQL em campo de busca
const maliciousInput = "'; DROP TABLE clientes; --";

const { data } = await supabase
  .from('clientes')
  .select('*')
  .ilike('nome', `%${maliciousInput}%`);
```

**Resultado Esperado:**
- ‚úÖ Query deve ser sanitizada automaticamente pelo Supabase
- ‚úÖ Nenhuma tabela deve ser dropada
- ‚úÖ Query deve retornar 0 resultados normalmente

---

### üîç Teste 4: Auditoria

#### Objetivo
Validar que a√ß√µes importantes s√£o registradas no log de auditoria.

#### Cen√°rios de Teste

##### A) Reset de senha de usu√°rio

**Setup:**
1. Admin faz reset de senha de um usu√°rio
2. Verificar se foi registrado em `user_audit_log`

**Teste:**
```typescript
// Admin reseta senha
await resetUserPassword(userId);

// Verificar log
const { data } = await supabase
  .from('user_audit_log')
  .select('*')
  .eq('user_id', userId)
  .eq('action', 'password_reset')
  .order('created_at', { ascending: false })
  .limit(1);

// ‚úÖ Deve existir um registro
expect(data).toHaveLength(1);
expect(data[0].performed_by).toBe(adminUserId);
```

**Resultado Esperado:**
- ‚úÖ Log de auditoria criado
- ‚úÖ Cont√©m: user_id, action, performed_by, timestamp
- ‚úÖ Detalhes incluem IP e User-Agent (se dispon√≠vel)

---

### ‚úÖ Teste 5: Valida√ß√£o de Roles

#### Objetivo
Garantir que roles est√£o armazenados APENAS na tabela `user_roles` e n√£o em profiles.

#### Teste:

**Verifica√ß√£o Manual no Supabase Dashboard:**

1. Ir para: SQL Editor
2. Executar:
```sql
-- ‚ùå Esta query N√ÉO deve existir (roles n√£o devem estar em profiles)
SELECT column_name 
FROM information_schema.columns 
WHERE table_name = 'profiles' 
  AND column_name IN ('role', 'roles', 'user_role');

-- ‚úÖ Esperado: 0 resultados

-- ‚úÖ Verificar que user_roles existe
SELECT EXISTS (
  SELECT 1 FROM information_schema.tables 
  WHERE table_name = 'user_roles'
);
-- Esperado: true
```

3. Verificar estrutura de `user_roles`:
```sql
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'user_roles';

-- ‚úÖ Deve ter:
-- - id (uuid)
-- - user_id (uuid)
-- - role (app_role enum)
-- - organizacao_id (uuid)
-- - created_at (timestamp)
```

**Resultado Esperado:**
- ‚úÖ Tabela `profiles` N√ÉO cont√©m colunas de role
- ‚úÖ Tabela `user_roles` existe e est√° populada
- ‚úÖ Enum `app_role` existe com valores: admin, gerente, atendente, colaborador, prestador, cliente

---

## 6.2 Testes de Fluxos Completos

### üßë‚Äçüíº Fluxo 1: Cliente

#### Setup
- Usu√°rio novo sem cadastro

#### Passos:

1. **Cadastro**
   - [ ] Acessar `/cadastro/cliente`
   - [ ] Preencher formul√°rio com dados v√°lidos
   - [ ] CPF deve ser validado
   - [ ] Email deve ser √∫nico
   - [ ] Senha m√≠nimo 8 caracteres
   - [ ] Submeter formul√°rio

2. **Verifica√ß√£o de Email**
   - [ ] Receber email de confirma√ß√£o
   - [ ] Clicar no link de verifica√ß√£o
   - [ ] Email deve conter c√≥digo de autentica√ß√£o (se aplic√°vel)

3. **Login**
   - [ ] Fazer login com credenciais
   - [ ] Redirecionado para `/cliente/dashboard`
   - [ ] Dashboard mostra dados do cliente

4. **Busca no Marketplace**
   - [ ] Navegar para marketplace
   - [ ] Buscar servi√ßo espec√≠fico
   - [ ] Ver detalhes do servi√ßo

5. **Solicitar Agendamento**
   - [ ] Clicar em "Agendar"
   - [ ] Selecionar data
   - [ ] Selecionar hor√°rio
   - [ ] Ver pr√©-visualiza√ß√£o do or√ßamento
   - [ ] Confirmar agendamento

6. **Receber Or√ßamento**
   - [ ] Receber notifica√ß√£o in-app
   - [ ] Receber email
   - [ ] Ver or√ßamento em `/cliente/orcamentos`

7. **Aceitar Or√ßamento**
   - [ ] Abrir modal de detalhes
   - [ ] Revisar informa√ß√µes
   - [ ] Clicar em "Aceitar"
   - [ ] Or√ßamento convertido em venda
   - [ ] Guias geradas

8. **Receber Confirma√ß√£o**
   - [ ] Email de confirma√ß√£o enviado
   - [ ] C√≥digo de autentica√ß√£o gerado
   - [ ] Agendamento vis√≠vel no dashboard

9. **Comparecer ao Servi√ßo**
   - [ ] Apresentar c√≥digo no dia
   - [ ] Status da guia atualizado para "realizada"

10. **Avaliar Servi√ßo**
    - [ ] Receber solicita√ß√£o de avalia√ß√£o
    - [ ] Deixar nota de 1-5 estrelas
    - [ ] Adicionar coment√°rio (opcional)
    - [ ] Submeter avalia√ß√£o

**Resultado Esperado:**
- ‚úÖ Fluxo completo sem erros
- ‚úÖ Todos os emails enviados
- ‚úÖ Notifica√ß√µes funcionando
- ‚úÖ Dados persistidos corretamente

---

### üë®‚Äç‚öïÔ∏è Fluxo 2: Prestador

#### Passos:

1. **Cadastro**
   - [ ] Acessar `/cadastro/prestador`
   - [ ] Preencher formul√°rio multi-step:
     - Etapa 1: Tipo (PF/PJ)
     - Etapa 2: Dados pessoais/empresariais
     - Etapa 3: Especialidades
     - Etapa 4: Dados banc√°rios
     - Etapa 5: Upload de documentos
   - [ ] Status inicial: `aguardando_aprovacao`

2. **Aprova√ß√£o pelo Admin**
   - [ ] Admin v√™ solicita√ß√£o em `/hub/aprovacoes`
   - [ ] Admin visualiza detalhes
   - [ ] Admin aprova cadastro
   - [ ] Registro criado em `prestadores`
   - [ ] Role 'prestador' atribu√≠do em `user_roles`

3. **Receber Credenciais**
   - [ ] Email de aprova√ß√£o enviado
   - [ ] Credenciais de acesso inclu√≠das
   - [ ] Link para login

4. **Login**
   - [ ] Login com credenciais
   - [ ] Redirecionado para `/prestador/portal`

5. **Configurar Agenda e Servi√ßos**
   - [ ] Configurar hor√°rios de disponibilidade
   - [ ] Listar servi√ßos oferecidos
   - [ ] Definir valores

6. **Receber Guia**
   - [ ] Notifica√ß√£o de nova guia
   - [ ] Ver detalhes da guia
   - [ ] C√≥digo de autentica√ß√£o do cliente

7. **Executar Servi√ßo**
   - [ ] Validar c√≥digo do cliente
   - [ ] Executar procedimento
   - [ ] Atualizar status para "realizada"

8. **Solicitar Faturamento**
   - [ ] Acessar painel de faturamento
   - [ ] Ver guias realizadas
   - [ ] Solicitar pagamento
   - [ ] Pagamento agendado em `agenda_pagamentos`

**Resultado Esperado:**
- ‚úÖ Aprova√ß√£o funciona
- ‚úÖ Acesso ao portal
- ‚úÖ Gest√£o de guias
- ‚úÖ Faturamento correto

---

### üè¢ Fluxo 3: Hub (Atendente)

#### Passos:

1. **Login**
   - [ ] Login como atendente
   - [ ] Redirecionado para `/hub/dashboard`
   - [ ] Dashboard personalizado para role

2. **Nova Venda**
   - [ ] Clicar em "Nova Venda"
   - [ ] Stepper vis√≠vel com etapas

3. **Buscar Cliente**
   - [ ] Buscar cliente por CPF/nome
   - [ ] Cliente encontrado: mostrar dados
   - [ ] Cliente n√£o encontrado: op√ß√£o de cadastrar

4. **Selecionar Servi√ßos**
   - [ ] Buscar servi√ßos dispon√≠veis
   - [ ] Adicionar m√∫ltiplos servi√ßos
   - [ ] Ver subtotal atualizado
   - [ ] Aplicar descontos (se aplic√°vel)

5. **Checkout**
   - [ ] Revisar itens
   - [ ] Selecionar m√©todo de pagamento
   - [ ] Gerar c√≥digo de barras (se boleto)
   - [ ] Finalizar venda

6. **Pagamento**
   - [ ] Registrar pagamento
   - [ ] Venda criada em `vendas`
   - [ ] Servi√ßos criados em `vendas_servicos`
   - [ ] Guias geradas automaticamente

7. **Controle Financeiro**
   - [ ] Acessar `/hub/financeiro`
   - [ ] Ver contas a receber
   - [ ] Ver contas a pagar
   - [ ] Filtrar por per√≠odo

8. **Agendar Pagamentos**
   - [ ] Acessar agenda de pagamentos
   - [ ] Definir data de pagamento para prestador
   - [ ] Confirmar agendamento

**Resultado Esperado:**
- ‚úÖ Venda finalizada com sucesso
- ‚úÖ Guias geradas
- ‚úÖ Financeiro atualizado
- ‚úÖ Notifica√ß√µes enviadas

---

## 6.3 Checklist de Performance

### ‚úÖ √çndices de Banco de Dados

- [x] `idx_agendamentos_data` - Agendamentos por data
- [x] `idx_agendamentos_cliente` - Agendamentos por cliente
- [x] `idx_agendamentos_prestador` - Agendamentos por prestador
- [x] `idx_guias_status` - Guias por status
- [x] `idx_guias_cliente` - Guias por cliente
- [x] `idx_guias_prestador` - Guias por prestador
- [x] `idx_vendas_created_at` - Vendas por data
- [x] `idx_avaliacoes_prestador` - Avalia√ß√µes por prestador
- [x] `idx_notifications_unread` - Notifica√ß√µes n√£o lidas (partial index)

### ‚úÖ Configura√ß√£o de Cache (React Query)

- [x] Dados est√°ticos: 10 minutos (organiza√ß√µes, servi√ßos)
- [x] Dados semi-est√°ticos: 5 minutos (prestadores, clientes)
- [x] Dados din√¢micos: 1 minuto (agendamentos, vendas)
- [x] Realtime: 0 cache (notifica√ß√µes)

### üì¶ Lazy Loading

**Componentes para Lazy Load:**

```typescript
// src/components/layout/LazyPages.tsx
export const LazyVendas = lazy(() => import('@/pages/Vendas'));
export const LazyOrcamentos = lazy(() => import('@/pages/Orcamentos'));
export const LazyRelatorios = lazy(() => import('@/pages/RelatoriosCentralizadosPage'));
export const LazyFinanceiro = lazy(() => import('@/pages/Financeiro'));
export const LazyGuias = lazy(() => import('@/pages/Guias'));
export const LazyQualityPage = lazy(() => import('@/pages/quality/QualityPage'));
export const LazySecurityPage = lazy(() => import('@/pages/security/SecurityPage'));
```

**Checklist:**
- [ ] Rotas pesadas usando lazy loading
- [ ] Suspense boundaries configurados
- [ ] Loading states adequados

### üñºÔ∏è Otimiza√ß√£o de Imagens

- [ ] Imagens lazy loaded
- [ ] Formato WebP quando poss√≠vel
- [ ] Dimens√µes apropriadas (n√£o carregar 4K para thumbnails)
- [ ] Placeholder durante carregamento

### üìä Code Splitting

- [ ] Rotas divididas por portal (hub, prestador, cliente)
- [ ] Componentes grandes lazy loaded
- [ ] Bibliotecas pesadas (ex: PDF) carregadas sob demanda

### üéØ M√©tricas de Performance

**Ferramentas para Monitorar:**

1. **Lighthouse (Chrome DevTools)**
   - Performance Score > 80
   - First Contentful Paint < 2s
   - Time to Interactive < 4s
   - Cumulative Layout Shift < 0.1

2. **React DevTools Profiler**
   - Identificar componentes lentos
   - Re-renders desnecess√°rios

3. **Network Tab**
   - Bundle size total < 500KB (gzipped)
   - Chunks individuais < 200KB
   - Requests < 50 no carregamento inicial

4. **Bundle Analyzer**
```bash
npm run build
npx vite-bundle-visualizer
```

### üöÄ Otimiza√ß√µes Aplicadas

- [x] ‚úÖ √çndices de banco adicionados
- [x] ‚úÖ Cache do React Query configurado
- [ ] üîÑ Lazy loading implementado
- [ ] üîÑ Imagens otimizadas
- [ ] üîÑ Code splitting completo
- [ ] üîÑ Service Worker para cache offline

---

## üìù Notas Finais

### Ferramentas √öteis

- **Supabase Dashboard**: https://supabase.com/dashboard
- **React Query Devtools**: Habilitado em desenvolvimento
- **Chrome DevTools**: Performance, Network, Lighthouse

### Comandos √öteis

```bash
# Rodar testes
npm run test

# An√°lise de bundle
npm run build
npx vite-bundle-visualizer

# Lighthouse CI
npx lighthouse https://app.agendaja.com.br --view

# Verificar cobertura de testes
npm run test:coverage
```

### Links de Refer√™ncia

- [Supabase RLS](https://supabase.com/docs/guides/auth/row-level-security)
- [React Query](https://tanstack.com/query/latest/docs/react/overview)
- [Web Vitals](https://web.dev/vitals/)
- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
